<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width,  initial-scale=1.0">
  <title>抽题机加强版 (^_^)</title>
  <style>
    :root {
        --primary-color: #6C63FF;
        --secondary-color: #4CAF50;
        --text-color: #2C3E50;
        --background-color: #F8F9FA;
        --accent-color: #FF6B6B;
        --shadow-color: rgba(0, 0, 0, 0.1);
        --glow-color: rgba(108, 99, 255, 0.2);
    }

    body {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        background-color: var(--background-color);
        font-family: 'Helvetica Neue', sans-serif;
        margin: 0;
        padding: 20px;
        color: var(--text-color);
        transition: all 0.3s ease;
    }

    h2 {
        text-align: center;
        font-family: 'Helvetica Neue', sans-serif;
        color: var(--primary-color);
        font-size: 36px;
        margin: 10px 0;
        font-weight: 600;
        letter-spacing: 2px;
    }

    h3 {
        font-family: 'Helvetica Neue', sans-serif;
        color: var(--primary-color);
        font-size: 28px;
        margin: 0 0 60px 0;
        font-weight: 500;
    }

    #timer {
        font-size: 30px;
        margin-bottom: 30px;
        font-family: 'Helvetica Neue',  sans-serif;
        color: var(--secondary-color);
        font-weight: 600;
        transition: all 0.3s ease;
        display: inline-block;
    }
    
    .text-wrapper {
        margin-top: 0;
        height: 80px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .q-text {
        font-size: 30px;
        font-family: 'Helvetica Neue', sans-serif;
        color: var(--primary-color);
        font-weight: 600;
    }

    button {
        padding: 16px 32px;
        margin: 5px;
        font-size: 20px;
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px var(--shadow-color);
        line-height: 1;
        min-width: 100px;
        align-self: center;
    }

    button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transition: none;
    }

    #stopBtn {
        background-color: var(--accent-color);
    }
    #stopBtn:hover {
        background-color: #ff8585;
        transform: translateY(-2px);
    }

    #startBtn {
        background-color: var(--secondary-color);
    }
    #startBtn:hover {
        background-color: #5dc561;
        transform: translateY(-2px);
    }
    #resetBtn:hover {
        background-color: #7d75ff;
        transform: translateY(-2px);
    }

    .btn-wrapper {
        margin-top: 80px;
        height: 45px;
        display: flex;
        gap: 15px;
    }

    .desc {
        font-family: 'Helvetica Neue',  sans-serif;
        font-size: 21px;
        color: var(--text-color);
        opacity: 0.8;
        text-align: center;
        max-width: 600px;
        line-height: 1.6;
    }

    .outer-box {
        justify-content: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 80px 120px 60px 120px;
        height: 340px;
        margin-top: 8px;
        background: white;
        border-radius: 20px;
        box-shadow: 0 10px 20px var(--shadow-color);
        transition: all 0.3s ease;
    }
    .norm-text {
        font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
    }

    .mode-hint {
        color: var(--primary-color);
        font-size: 24px;
        font-weight: 500;
        margin: 15px 0;
        text-align: center;
        min-height: 36px;
    }

    .result-display {
        margin: 15px 0;
        font-size: 20px;
        color: var(--text-color);
        min-height: 50px;
        text-align: center;
    }

    .result-display div {
        margin: 12px 0;
        line-height: 1.4;
        padding: 10px;
        background: rgba(108, 99, 255, 0.1);
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .speech-bubble {
        position: relative;
        background: #ffffff;
        border-radius: 8px;
        padding: 15px 15px 15px 15px;
        box-shadow: 0 4px 8px var(--shadow-color);
        transition: all 0.3s ease;
        border: 2px solid var(--primary-color);
    }

    .speech-bubble:after {
        content: '';
        position: absolute;
        bottom: -10px;
        right: 20px;
        width: 0;
        height: 0;
        border: 10px solid transparent;
        border-top-color: var(--primary-color);
        border-bottom: 0;
        margin-right: 0;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .fade-in {
        animation: fadeIn 0.5s ease forwards;
    }

    @keyframes backgroundPulse {
        0% { background-color: var(--background-color); }
        50% { background-color: var(--glow-color); }
        100% { background-color: var(--background-color); }
    }

    @keyframes timerPulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.2); color: #FF6B6B; }
        100% { transform: scale(1); }
    }

    @keyframes textGlow {
        0% { text-shadow: 0 0 5px var(--primary-color); }
        50% { text-shadow: 0 0 20px var(--primary-color); }
        100% { text-shadow: 0 0 5px var(--primary-color); }
    }

    @keyframes boxShadowPulse {
        0% { box-shadow: 0 10px 20px var(--shadow-color); }
        50% { box-shadow: 0 15px 30px var(--glow-color); }
        100% { box-shadow: 0 10px 20px var(--shadow-color); }
    }

    .countdown-active {
        animation: backgroundPulse 2s infinite;
    }

    .timer-active {
        animation: timerPulse 1s infinite;
        transform-origin: center;
    }

    .text-active {
        animation: textGlow 2s infinite;
    }

    .box-active {
        animation: boxShadowPulse 2s infinite;
    }

  </style>
  <!-- 添加讯飞WebAPI SDK -->
  <script src="https://webapi.xfyun.cn/v1/aiui/js/websocket_base64.js"></script>
  <script src="https://webapi.xfyun.cn/v1/aiui/js/pcm-player.js"></script>
  <script src="https://webapi.xfyun.cn/v1/aiui/js/WebIAT.js"></script>
</head>

<body>
  <h2>抽题机加强版 (⌐■_■)</h2>
  <audio id="countdownAudio" loop>
    <source src="countdown.mp3" type="audio/mpeg">
  </audio>
  <h3>熟谱视唱</h3>
  <div class="desc">要求：给开始音，打节拍图示，自己起速度，只唱一遍。</div>
  <div class="outer-box">
    <div class="speech-bubble" style="position: fixed; left: 18%; top: 45%; transform: translatdeY(-50%);">
        <div id="mode-hint" class="mode-hint">请先抽单声部题目</div>
    </div>
    <div><span class="norm-text">倒计时：</span><span id="timer">10.00s</span></div>
    <div class="text-wrapper">
        <span class="norm-text">你的题目是：</span>
        <span class="q-text" id="group">--</span>
        <span class="q-text" id="question">--</span>
    </div>
    <div id="result-display" class="result-display">
        <div id="single-result"></div>
        <div id="multiple-result"></div>
    </div>
    <div class="btn-wrapper">
        <button id="resetBtn">重置</button>
        <button id="startBtn">开始</button>
        <button id="stopBtn">停！</button>
    </div>
  </div>

  <div class="desc" style="margin-top: 60px; font-size: 16px; color: #666;">
    ( 提示：朝我喊" 停！"可以停止倒计时！)
  </div>

  <script>
    const INIT_COUNT_DOWN = 10.00;
    const ALL_GROUPS_SINGLE = ['单', '1B'];
    const ALL_GROUPS_MULTIPLE = ['多', '斯'];
    const ALL_QUESITONS = {
        '单': [132, 135, 147, 150, 137, 144, 151, 155, 159, 163, 167, 170, 173, 187, 189, 198, 207, 208, 209, 222, 223, 235, 241, 248, 253, 284, 286, 292, 291, 296, 300, 301], 
        '1B': [98, 99, 100, 101, 102, 107, 110, 134, 135, 137, 139, 141, 142],
        '多': [1, 7, 8, 9, 82, 84, 14, 17, 22, 90, 26, 32, 85, 91],
        '斯': [1, 2, 3, 4, 6, 7, 9, 10, 24, 37, 15, 25]
    };

    let timer = INIT_COUNT_DOWN;
    let interval;
    let questions = JSON.parse(JSON.stringify(ALL_QUESITONS));
    let gIndex = 0;
    let qIndex = 0;

    const timerElement = document.getElementById('timer');
    const groupElement = document.getElementById('group');
    const questionElement = document.getElementById('question');
    const startBtn = document.getElementById('startBtn');
    const resetBtn = document.getElementById('resetBtn');
    const stopBtn = document.getElementById('stopBtn');
    
    stopBtn.disabled = true;

    // 替换原有的语音识别初始化代码
    let xfRecognition;

    function initSpeechRecognition() {
        try {
            // 检查SDK是否正确加载
            if (typeof WebIAT === 'undefined') {
                throw new Error('讯飞SDK未能正确加载，请检查网络连接');
            }

            // 配置讯飞语音识别
            const config = {
                // 使用您的讯飞开放平台应用凭证
                "appid": "4da6c04e",
                "api_key": "d5d0e4e16e49e9750206c787d974146b",
                "api_secret": "ZTYxN2Y4ZDNmNjM0ZWY2YzUxZTdkYTMw",
                // 设置参数
                "accent": "mandarin", // 设置普通话
                "sample_rate": "16000", // 采样率16k
                "vad_eos": "1000", // 后端点检测时间1秒
                "enable_punctuation": true, // 开启标点符号
                "enable_intermediate_result": true, // 开启中间结果返回
                "language": "zh_cn" // 设置语言为中文
            };

            xfRecognition = new WebIAT(config);

            // 添加连接状态监听
            xfRecognition.onOpen = function() {
                console.log('语音识别连接已立');
            };

            xfRecognition.onClose = function() {
                console.log('语音识别连接已关闭');
            };

            // 监听识别结果
            xfRecognition.onResult = function(result) {
                try {
                    if (result && result.data) {
                        // 解析JSON结果
                        const resultData = JSON.parse(result.data);
                        if (resultData.result) {
                            const transcript = resultData.result.text;
                            console.log('识别到的语音:', transcript);
                            
                            // 检查是否包含"停"字
                            if (transcript.includes('停')) {
                                console.log('检测到停止命令');
                                stopBtn.click();
                            }
                        }
                    }
                } catch (error) {
                    console.error('解析识别结果时出错:', error);
                }
            };

            // 监听错误
            xfRecognition.onError = function(error) {
                console.error('语音识别错误:', error);
                // 发错时尝试重新初始化
                setTimeout(initSpeechRecognition, 3000);
            };

            console.log('语音识别初始化成功');
        } catch (error) {
            console.error('初始化语音识别时发生错误:', error);
        }
    }

    // 初始化语音识别
    initSpeechRecognition();

    function reportLeftNumber() {
        console.log('现在剩多少条问题？', 
            '单声部 - 单: ', questions['单'].length, 
            '1B: ', questions['1B'].length,
            '多声部 - 多: ', questions['多'].length,
            '斯: ', questions['斯'].length
        );
    }

    // 添加音频元素引
    const countdownAudio = document.getElementById('countdownAudio');
    
    // 添加音频状态控制
    let isPlaying = false;
    
    // 修改音频控制函数
    async function playAudio() {
        if (isPlaying) return;
        
        try {
            // countdownAudio.currentTime = 0;
            isPlaying = true;
            await countdownAudio.play();
        } catch (error) {
            console.log("播放音频出错:", error);
            isPlaying = false;
        }
    }

    async function stopAudio() {
        if (!isPlaying) return;
        
        try {
            await new Promise(resolve => setTimeout(resolve, 100)); // 添加小延迟
            countdownAudio.pause();
            isPlaying = false;
        } catch (error) {
            console.log("停止音频出错:", error);
        }
    }
    
    // 添加一个状态变量来跟踪当前是单声部还是多声部
    let currentMode = 'single'; // 'single' 或 'multiple'

    // 在 script 标签开始处添加新的状态变量
    let singlePartQuestion = null; // 用于存储单声部题目

    // 添加新的DOM元素引用
    const modeHintElement = document.getElementById('mode-hint');
    const resultDisplay = document.getElementById('result-display');
    const singleResult = document.getElementById('single-result');
    const multipleResult = document.getElementById('multiple-result');

    // 修改 startBtn 的点击事件处理
    startBtn.addEventListener('click', async () => {
        if (timer && timer < INIT_COUNT_DOWN) return;

        console.log('开始抽题: ', countdownAudio.currentTime);
        
        reportLeftNumber();
        stopBtn.disabled = false;
        
        // 根据当前模式显示提示
        if (currentMode === 'single') {
            modeHintElement.textContent = '请先抽单声部题目';
            singleResult.textContent = '';
            multipleResult.textContent = '';
        } else {
            modeHintElement.textContent = '接下来，请抽多声部题目';
            // 重置倒计时
            timer = INIT_COUNT_DOWN;
            timerElement.textContent = timer.toFixed(2) + 's';
        }
        
        // 启动讯飞语音识别
        if (xfRecognition) {
            try {
                await xfRecognition.start();
                console.log('语音识别已启动');
            } catch (error) {
                console.error('启动语音识别失败:', error);
                initSpeechRecognition();
            }
        } else {
            console.warn('语音识别未初始化，正在重新初始化...');
            initSpeechRecognition();
        }

        await playAudio();

        // 添加动画类
        document.body.classList.add('countdown-active');
        timerElement.classList.add('timer-active');
        groupElement.classList.add('text-active');
        questionElement.classList.add('text-active');
        document.querySelector('.outer-box').classList.add('box-active');

        interval = setInterval(() => {
            timer -= 0.02;
            timerElement.textContent = timer.toFixed(2) + 's';
            
            // 根据当前模式选择不同的组别
            const currentGroups = currentMode === 'single' ? ALL_GROUPS_SINGLE : ALL_GROUPS_MULTIPLE;
            gIndex = Math.floor(Math.random() * currentGroups.length);
            const currentGroupName = currentGroups[gIndex];
            qIndex = Math.floor(Math.random() * questions[currentGroupName].length);
            
            groupElement.textContent = currentGroupName;
            questionElement.textContent = questions[currentGroupName][qIndex];
            
            if (timer <= 0) {
                clearInterval(interval);
                timerElement.textContent = 0.00.toFixed(2) + 's';
                startBtn.disabled = true;
                stopBtn.disabled = true;
                stopAudio();
                
                // 移除动画类
                document.body.classList.remove('countdown-active');
                timerElement.classList.remove('timer-active');
                groupElement.classList.remove('text-active');
                questionElement.classList.remove('text-active');
                document.querySelector('.outer-box').classList.remove('box-active');
            }
        }, 20);
    });

    // 修改 stopBtn 的点击事件处理
    stopBtn.addEventListener('click', () => {
        clearInterval(interval);

        if (xfRecognition) {
            xfRecognition.stop();
        }

        stopAudio();

        // 获取当前组别
        const currentGroups = currentMode === 'single' ? ALL_GROUPS_SINGLE : ALL_GROUPS_MULTIPLE;
        const currentGroupName = currentGroups[gIndex];

        // 从题库中移除已抽到的题目
        questions[currentGroupName].splice(qIndex, 1);
        if (questions[currentGroupName].length === 0) {
            const groupIndex = currentGroups.indexOf(currentGroupName);
            if (groupIndex > -1) {
                currentGroups.splice(groupIndex, 1);
            }
        }

        timerElement.textContent = timer.toFixed(2) + 's';
        
        // 切换模式
        if (currentMode === 'single') {
            // 保存单声部题目
            singlePartQuestion = {
                group: groupElement.textContent,
                question: questionElement.textContent
            };
            
            // 显示单声部题目
            singleResult.textContent = `你的单声部题目是：${singlePartQuestion.group} ${singlePartQuestion.question}`;
            singleResult.classList.add('fade-in');
            modeHintElement.textContent = '接下来，请抽多声部题目';
            
            // 切换到多声部模式
            currentMode = 'multiple';
            startBtn.disabled = false;
            console.log('切换到多声部模式');
            
            // 重置倒计时和音频
            timer = INIT_COUNT_DOWN;
            timerElement.textContent = timer.toFixed(2) + 's';

        } else {
            // 显示多声部题目
            multipleResult.textContent = `你的多声部题目是：${groupElement.textContent} ${questionElement.textContent}`;
            multipleResult.classList.add('fade-in');
            modeHintElement.textContent = '本轮抽题结束';
            startBtn.disabled = true;
            countdownAudio.currentTime = 0; // 确保音频重置到开始位置
            console.log('本轮抽题结束');
        }

        // 移除动画类
        document.body.classList.remove('countdown-active');
        timerElement.classList.remove('timer-active');
        groupElement.classList.remove('text-active');
        questionElement.classList.remove('text-active');
        document.querySelector('.outer-box').classList.remove('box-active');
    });

    // 修改 resetBtn 的点击事件处理
    resetBtn.addEventListener('click', () => {
        clearInterval(interval);
        
        if (xfRecognition) {
            try {
                xfRecognition.stop();
                console.log('语音识别已停止');
            } catch (error) {
                console.error('停止语音识别失败:', error);
            }
        }

        stopAudio();
        
        timer = INIT_COUNT_DOWN;
        timerElement.textContent = timer.toFixed(2) + 's';
        groupElement.textContent = '--';
        questionElement.textContent = '--';
        startBtn.disabled = false;
        stopBtn.disabled = true;
        currentMode = 'single'; // 重置为单声部模式
        singlePartQuestion = null; // 重置单声部题目
        
        // 重置题库
        // questions = JSON.parse(JSON.stringify(ALL_QUESITONS));
        
        modeHintElement.textContent = '请先抽单声部题目';
        singleResult.textContent = '';
        multipleResult.textContent = '';
        singleResult.classList.remove('fade-in');
        multipleResult.classList.remove('fade-in');

        // 移除动画类
        document.body.classList.remove('countdown-active');
        timerElement.classList.remove('timer-active');
        groupElement.classList.remove('text-active');
        questionElement.classList.remove('text-active');
        document.querySelector('.outer-box').classList.remove('box-active');
    });
  </script>
</body>

</html>